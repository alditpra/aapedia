---
import type { MarkdownHeading } from "astro";
import type { Heading } from "./TOCHeading.astro";
import TOCHeading from "./TOCHeading.astro";

interface Props {
  headings: MarkdownHeading[];
}

function buildToc(headings: MarkdownHeading[]): Heading[] {
  const toc: Heading[] = [];
  const parentHeadings = new Map();

  headings
    .filter((h) => h.depth <= 3)
    .forEach((h) => {
      const heading = { ...h, subheadings: [] };
      parentHeadings.set(heading.depth, heading);

      if (heading.depth === 2) {
        toc.push(heading);
      } else {
        parentHeadings.get(heading.depth - 1)?.subheadings.push(heading);
      }
    });

  return toc;
}

const { headings } = Astro.props;
const tableOfContents = buildToc(headings);
---

<div class="toc-container relative bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md border border-gray-100 dark:border-gray-700">
  <div class="flex justify-between items-center mb-3">
    <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Table of Contents</h2>
    <button id="toc-toggle" aria-label="Toggle table of contents" aria-expanded="true" class="text-gray-500 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400 p-1 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </button>
  </div>

  <div id="toc-content" class="toc-content overflow-y-auto pr-2 transition-all duration-300 ease-in-out">
    <ul class="text-sm space-y-2 list-none">
      {
        tableOfContents.map((heading) => (
          <TOCHeading heading={heading} />
        ))
      }
    </ul>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocToggle = document.getElementById('toc-toggle');
    const tocContent = document.getElementById('toc-content');

    if (tocToggle && tocContent) {
      tocContent.classList.add('toc-expanded');
      tocToggle.addEventListener('click', () => {
        tocContent.classList.toggle('toc-collapsed');
        tocContent.classList.toggle('toc-expanded');
        const isExpanded = tocContent.classList.contains('toc-expanded');
        tocToggle.setAttribute('aria-expanded', isExpanded.toString());
      });
    }
  });
</script>

<style>
  .toc-content ul li a {
    /* Pastikan link adalah flex container. Ini sudah kita atur di TOCHeading.astro,
       tapi menaruhnya di sini juga bisa sebagai cadangan. */
    display: flex;
    align-items: baseline;
  }

  .toc-content ul li a::after {
    content: "";
    flex-grow: 1; /* Membuatnya mengisi ruang kosong */
    border-bottom: 1px dotted #d1d5db; /* Warna abu-abu muda (Tailwind gray-300) */
    margin-left: 0.5rem; /* Memberi jarak dari teks */
    
    /* PENTING: Sejajarkan diri ke bawah lalu naik sedikit agar pas dengan baseline */
    align-self: flex-end;
    margin-bottom: 0.25rem; 
  }

  .dark .toc-content ul li a::after {
    border-color: #4b5563; /* Warna abu-abu gelap (Tailwind gray-600) */
  }

  /* Sisanya biarkan sama */
  .toc-content {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    max-height: 500px;
  }

  .toc-content.toc-collapsed {
    max-height: 0;
    overflow: hidden;
  }
 
  .toc-content::-webkit-scrollbar {
    width: 6px;
  }
 
  .toc-content::-webkit-scrollbar-track {
    background: transparent;
  }
 
  .toc-content::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 20px;
  }
 
  .dark .toc-content::-webkit-scrollbar-thumb {
    background-color: rgba(209, 213, 219, 0.5);
  }
 
  #toc-toggle[aria-expanded="false"] svg {
    transform: rotate(-90deg);
  }
 
  #toc-toggle svg {
    transition: transform 0.3s ease;
  }
</style>
